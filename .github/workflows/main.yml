name: Main CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  JAVA_VERSION: '17'
  JAVA_DISTRIBUTION: 'temurin'
  NODE_VERSION: '22'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: ${{ env.JAVA_DISTRIBUTION }}
        
    - name: Set up Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v6
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: Set up Android SDK
      uses: android-actions/setup-android@v3
      with:
        cmdline-tools-version: 11076708
        
    - name: Install required Android SDK packages
      run: |
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platforms;android-34" "build-tools;34.0.0" "platform-tools"
        echo "Installed SDK packages:"
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --list_installed
        
    - name: Cache Gradle packages
      uses: actions/cache@v5
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Cache Node modules
      uses: actions/cache@v5
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
          
    - name: Install bridge dependencies
      run: |
        cd bridge
        npm install
        
    - name: Grant execute permission for scripts
      run: |
        chmod +x scripts/*.sh
        chmod +x android/gradlew
      
    - name: Bundle bridge code
      run: ./scripts/bundle_bridge.sh
      
    - name: Compile project
      id: compile
      working-directory: android
      run: |
        ./gradlew compileDebugKotlin --continue --stacktrace --warning-mode all 2>&1 | tee compile_output.txt
        exit_code=${PIPESTATUS[0]}
        
        if [ $exit_code -ne 0 ]; then
          echo ""
          echo "::group::Compilation Errors (last 200 lines)"
          tail -200 compile_output.txt
          echo "::endgroup::"
          
          echo ""
          echo "::group::Error Summary"
          grep -E "^e: |error:|Error:|FAILURE:|BUILD FAILED" compile_output.txt || echo "No specific error pattern found"
          echo "::endgroup::"
        fi
        
        exit $exit_code
      continue-on-error: true
      
    - name: Report compilation results
      if: always()
      run: |
        if [ "${{ steps.compile.outcome }}" == "failure" ]; then
          echo "::error::Compilation failed. Check the 'Compilation Errors' section above for details."
        else
          echo "::notice::Compilation succeeded!"
        fi
    
    - name: Upload compilation log on failure
      if: steps.compile.outcome == 'failure'
      uses: actions/upload-artifact@v6
      with:
        name: compile-error-log
        path: android/compile_output.txt
        if-no-files-found: ignore
    
    - name: Run unit tests
      if: steps.compile.outcome == 'success'
      working-directory: android
      run: ./gradlew testDebugUnitTest --continue
      continue-on-error: true
      id: unit-tests
      
    - name: Run lint checks
      if: steps.compile.outcome == 'success'
      working-directory: android
      run: ./gradlew lintDebug --continue
      continue-on-error: true
      id: lint-checks
      
    - name: Fail workflow if compilation or tests failed
      if: always()
      run: |
        if [ "${{ steps.compile.outcome }}" == "failure" ] || [ "${{ steps.unit-tests.outcome }}" == "failure" ]; then
          echo "Workflow failed due to compilation or test failures"
          exit 1
        fi
      
    - name: Upload test reports
      uses: actions/upload-artifact@v6
      if: always()
      with:
        name: test-reports
        path: |
          android/app/build/reports/tests/
          android/app/build/reports/lint-results-debug.html

  build:
    name: Build APK
    runs-on: ubuntu-latest
    needs: test
    if: always()
    permissions:
      contents: read
    
    outputs:
      version-name: ${{ steps.version.outputs.version-name }}
      version-code: ${{ steps.version.outputs.version-code }}
      build-success: ${{ steps.build-debug.outcome == 'success' }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: ${{ env.JAVA_DISTRIBUTION }}
        
    - name: Set up Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v6
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: Set up Android SDK
      uses: android-actions/setup-android@v3
      with:
        cmdline-tools-version: 11076708
        
    - name: Install required Android SDK packages
      run: |
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platforms;android-34" "build-tools;34.0.0" "platform-tools"
        
    - name: Cache Gradle packages
      uses: actions/cache@v5
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Install bridge dependencies
      run: |
        cd bridge
        npm install
          
    - name: Grant execute permission for scripts
      run: |
        chmod +x scripts/*.sh
        chmod +x android/gradlew
        
    - name: Setup Node.js runtime for Android
      run: ./scripts/setup_runtime.sh
      
    - name: Bundle bridge code
      run: ./scripts/bundle_bridge.sh
      
    - name: Extract version information
      id: version
      working-directory: android
      run: |
        # Extract version from build.gradle
        VERSION_NAME=$(grep 'versionName' app/build.gradle | sed 's/.*"\(.*\)".*/\1/' | head -1 || echo "1.0.0")
        VERSION_CODE=$(grep 'versionCode' app/build.gradle | sed 's/[^0-9]*//g' | head -1 || echo "1")
        echo "version-name=$VERSION_NAME" >> $GITHUB_OUTPUT
        echo "version-code=$VERSION_CODE" >> $GITHUB_OUTPUT
        echo "Version Name: $VERSION_NAME"
        echo "Version Code: $VERSION_CODE"
      continue-on-error: true
        
    - name: Build debug APK
      id: build-debug
      working-directory: android
      run: |
        echo "Building debug APK..."
        ./gradlew assembleDebug --continue --stacktrace --warning-mode all 2>&1 | tee build_output.txt
        exit_code=${PIPESTATUS[0]}
        
        if [ $exit_code -ne 0 ]; then
          echo ""
          echo "::group::Build Errors (last 200 lines)"
          tail -200 build_output.txt
          echo "::endgroup::"
          
          echo ""
          echo "::group::Error Summary"
          grep -E "^e: |error:|Error:|FAILURE:|BUILD FAILED" build_output.txt || echo "No specific error pattern found"
          echo "::endgroup::"
        fi
        
        exit $exit_code
      continue-on-error: true
      
    - name: Report build status
      if: always()
      run: |
        if [ "${{ steps.build-debug.outcome }}" == "failure" ]; then
          echo "::error::Debug APK build failed. Check the 'Build Errors' section above for details."
        else
          echo "::notice::Debug APK built successfully!"
        fi
    
    - name: Upload build log on failure
      if: steps.build-debug.outcome == 'failure'
      uses: actions/upload-artifact@v6
      with:
        name: build-error-log
        path: android/build_output.txt
        if-no-files-found: ignore
      
    - name: Build release APK (unsigned)
      if: steps.build-debug.outcome == 'success'
      working-directory: android
      run: ./gradlew assembleRelease --continue
      continue-on-error: true
      
    - name: Sign release APK
      id: sign_apk
      if: steps.build-debug.outcome == 'success' && github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main')
      env:
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      run: |
        if [[ -n "$KEYSTORE_PASSWORD" && -n "$KEY_ALIAS" && -n "$KEY_PASSWORD" ]]; then
          echo "Signing APK with keystore..."
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > release-keystore.jks
          
          jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
            -keystore release-keystore.jks \
            -storepass "$KEYSTORE_PASSWORD" \
            -keypass "$KEY_PASSWORD" \
            android/app/build/outputs/apk/release/app-release-unsigned.apk \
            "$KEY_ALIAS"
            
          $ANDROID_HOME/build-tools/34.0.0/zipalign -v 4 \
            android/app/build/outputs/apk/release/app-release-unsigned.apk \
            android/app/build/outputs/apk/release/Amphibian-release-signed.apk
            
          echo "signed=true" >> $GITHUB_OUTPUT
        else
          echo "Keystore secrets not available, using unsigned APK"
          if [ -f "android/app/build/outputs/apk/release/app-release-unsigned.apk" ]; then
            cp android/app/build/outputs/apk/release/app-release-unsigned.apk \
               android/app/build/outputs/apk/release/Amphibian-release-unsigned.apk
          fi
          echo "signed=false" >> $GITHUB_OUTPUT
        fi
      continue-on-error: true
        
    - name: Rename APK files
      if: steps.build-debug.outcome == 'success'
      run: |
        VERSION_NAME="${{ steps.version.outputs.version-name }}"
        
        if [[ -f "android/app/build/outputs/apk/debug/app-debug.apk" ]]; then
          mv android/app/build/outputs/apk/debug/app-debug.apk \
             android/app/build/outputs/apk/debug/Amphibian-v${VERSION_NAME}-debug.apk
        fi
    
    - name: Generate checksums
      if: steps.build-debug.outcome == 'success'
      run: |
        VERSION_NAME="${{ steps.version.outputs.version-name }}"
        cd android/app/build/outputs/apk
        
        if [[ -f "debug/Amphibian-v${VERSION_NAME}-debug.apk" ]]; then
          sha256sum debug/Amphibian-v${VERSION_NAME}-debug.apk > debug/Amphibian-v${VERSION_NAME}-debug.apk.sha256
        fi
        
        if [[ -f "release/Amphibian-release-signed.apk" ]]; then
          sha256sum release/Amphibian-release-signed.apk > release/Amphibian-release-signed.apk.sha256
        fi
        
        echo "=== APK Checksums ==="
        cat debug/*.sha256 2>/dev/null || true
        cat release/*.sha256 2>/dev/null || true
        
    - name: Upload debug APK
      if: steps.build-debug.outcome == 'success'
      uses: actions/upload-artifact@v6
      with:
        name: debug-apk
        path: android/app/build/outputs/apk/debug/Amphibian-v${{ steps.version.outputs.version-name }}-debug.apk
        
    - name: Upload release APK
      if: steps.build-debug.outcome == 'success'
      uses: actions/upload-artifact@v6
      with:
        name: release-apk
        path: android/app/build/outputs/apk/release/Amphibian-*.apk

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build
    if: needs.build.outputs.build-success == 'true' && github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Download all APKs
      uses: actions/download-artifact@v7
      with:
        path: apks
    
    - name: Generate release notes
      id: release_notes
      run: |
        VERSION="${{ needs.build.outputs.version-name }}"
        TAG_NAME="${GITHUB_REF#refs/tags/}"
        
        PREVIOUS_TAG=$(git describe --abbrev=0 --tags "${TAG_NAME}^" 2>/dev/null || echo "")
        if [ -n "$PREVIOUS_TAG" ]; then
          COMMITS=$(git log "${PREVIOUS_TAG}..${TAG_NAME}" --pretty=format:"- %s" --no-merges)
        else
          COMMITS=$(git log "${TAG_NAME}" --pretty=format:"- %s" --no-merges --max-count=20)
        fi
        
        cat > release_notes.md << EOF
        ## Landseek-Amphibian ${VERSION}
        
        ðŸ¸ **On-Device AI Agent for Android**
        
        ### ðŸ“± System Requirements
        - Android 10+ (API level 29 or higher)
        - For TPU inference: Pixel 6+ or compatible device with NPU
        - 200 MB free storage space
        
        ### âœ¨ Features
        - 10 AI Personalities (Nova, Echo, Sage, Spark, Atlas, Luna, Cipher, Muse, Phoenix, Zen)
        - On-device LLM inference via MediaPipe (Gemma 3 4B)
        - 70+ document format support
        - P2P networking for shared AI capabilities
        - Full ClawdBot tool integration
        
        ### ðŸ“¦ Installation
        1. Download the APK below
        2. Enable "Install from unknown sources" in Android settings if needed
        3. Install the APK
        4. Grant required permissions
        
        ### ðŸŽ‰ Changes in this Release
        ${COMMITS}
        
        For bug reports and feature requests, please visit the [Issues page](https://github.com/Kaleaon/Landseek-Amphibian/issues).
        EOF
        
        echo "release_body<<EOF" >> $GITHUB_OUTPUT
        cat release_notes.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Create Release and Upload Assets
      uses: softprops/action-gh-release@v2
      with:
        name: Landseek-Amphibian ${{ needs.build.outputs.version-name }}
        body: ${{ steps.release_notes.outputs.release_body }}
        draft: false
        prerelease: false
        files: |
          ./apks/release-apk/Amphibian-*.apk
          ./apks/debug-apk/Amphibian-*.apk
          ./apks/release-apk/*.sha256
          ./apks/debug-apk/*.sha256
        fail_on_unmatched_files: false
